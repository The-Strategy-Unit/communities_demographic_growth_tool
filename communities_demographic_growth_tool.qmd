---
title: |
  Community Services: Projected Demographic Growth
subtitle: Projected care contacts to 2041, based on the 2022-23 CSDS dataset
author:
  name: Fran Barton
  email: francis.barton1@nhs.net
date: today
lang: en-GB
theme: sandstone
mainfont: "Segoe UI"
lightbox: true
embed-resources: true
fig-dpi: 96
fig-height: 10
fig-width: 16.18
fig-responsive: true
out-width: 92%
execute:
  warning: false
  echo: false
knitr:
  opts_chunk:
    dev: "ragg_png"
---

```{scss}

:root {
  // --bs-body-color: #9d928a; // SU "light charcoal" palette colour
  --bs-body-color: #595959; // R colour grey35
  --bs-body-bg: #faf0e6; // "linen"
}

```

```{r setup}
library(dplyr)
library(forcats)
library(ggplot2)
library(gt)
library(ragg)
library(StrategyUnitTheme)
library(systemfonts)

contacts_data <- readr::read_rds("contacts_fy_projected_icb.rds")

# text_grey <- "#3e3f3a" # sandstone theme default text colour
# text_grey <- su_theme_cols("light_charcoal")
text_grey <- "grey35"

su_chart_theme <- function(font_family = "Segoe UI") {
  su_slate <- su_theme_cols("light_slate")
  dark_slate <- su_theme_cols("dark_slate")
  l_orange <- su_theme_cols("light_orange")
  slate_tr <- "#b2b7b999"
  coral_tr <- "#ff7f5099"
  ggplot2::theme(
    text = element_text(family = font_family, size = 24, colour = dark_slate),
    title = element_text(hjust = 0.05, face = "bold"),
    plot.title = element_text(
      size = 32,
      margin = margin(20, 8, 12, 18)
    ),
    plot.subtitle = element_text(face = "plain", margin = margin(2, 0, 2, 20)),
    plot.caption = element_text(
      hjust = 0.96,
      face = "plain",
      size = 20,
      margin = margin(12, 6, 6, 0)
    ),
    plot.title.position = "plot",
    plot.background = element_rect(fill = "linen", colour = NA),
    plot.margin = margin(6, 24, 6, 6),
    panel.background = element_rect(fill = "linen"),
    legend.title = element_text(hjust = 0, margin = margin(b = 8)),
    legend.background = element_rect(fill = "linen"),
    legend.margin = margin(r = 30),
    legend.key = element_rect(fill = "linen"),
    legend.key.spacing.y = grid::unit(3, "mm"),
    legend.key.width = unit(18, "mm"),
    legend.text = element_text(margin = margin(l = 16), hjust = 1),
    panel.grid.major = element_line(
      colour = slate_tr,
      linewidth = 0.2,
      lineend = "butt"
    ),
    panel.grid.minor = element_line(
      colour = coral_tr,
      linewidth = 0.1,
      lineend = "butt"
    ),
    # panel.grid.major = element_blank(),
    # panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    # axis.line = element_line(
    #   colour = "#b2b7b9",
    #   linewidth = 1.5,
    #   lineend = c("round", "butt")
    # ),
    axis.ticks = element_blank(),
    # axis.ticks = element_line(
    #   colour = slate_tr,
    #   linewidth = 1.5,
    #   lineend = c("round", "butt"),
    # ),
    # axis.title.x = element_text(margin = margin(t = 8, b = 18)),
    # axis.title.y = element_text(margin = margin(r = 8, l = 18)),
    axis.text.x = element_text(
      angle = 45,
      vjust = 0.5,
      hjust = 0.5,
      margin = margin(t = 8, b = 16)
    ),
    axis.text.y = element_text(margin = margin(r = 4, l = 16)),
    strip.background = element_rect(fill = dark_slate, colour = NA),
    strip.text = element_text(colour = "grey95", size = 14),
    validate = TRUE
  )
}

```


```{r data-summary-functions}

summarise_total_contacts_by_year <- function(x) {
  x |>
    purrr::map(\(x) {
      x |>
        dplyr::summarise(
          dplyr::across("projected_contacts", sum),
          .by = "fin_year"
        )
    })
}

add_age_groups <- function(.data) {
  .data |>
    dplyr::mutate(
      age_group_cat = dplyr::case_when(
        age_int == 0L ~ "0",
        age_int %in% seq(1L, 4L) ~ "1-4",
        age_int %in% seq(5L, 9L) ~ "5-9",
        age_int %in% seq(10L, 15L) ~ "10-15",
        age_int %in% seq(16L, 17L) ~ "16-17",
        age_int %in% seq(18L, 34L) ~ "18-34",
        age_int %in% seq(35L, 49L) ~ "35-49",
        age_int %in% seq(50L, 64L) ~ "50-64",
        age_int %in% seq(65L, 74L) ~ "65-74",
        age_int %in% seq(75L, 84L) ~ "75-84",
        .default = "85+"
      ),
      across(age_group_cat, forcats::fct_inorder),
      .keep = "unused"
    )
}

add_broad_age_groups <- function(.data) {
  .data |>
    dplyr::mutate(
      broad_age_cat = dplyr::case_when(
        age_int %in% seq(0L, 15L) ~ "0-15",
        age_int %in% seq(16L, 49L) ~ "16-49",
        age_int %in% seq(50L, 74L) ~ "50-74",
        .default = "75+"
      ),
      across(broad_age_cat, forcats::fct_inorder),
      .keep = "unused"
    )
}




```


```{r data-quality}

# Data quality calculations go here, before we filter to consistent only.



```


## National contacts projection by financial year


```{r chart1}
#| eval: false


contacts_fy_projected_national |>
  ggplot2::ggplot(aes(fin_year, total_contacts_by_year)) +
  ggplot2::geom_line()



```
